#!/bin/bash

# claude+ - wrapper to run claude as non-root user
# Usage: claude+ [any claude arguments]

TEMP_USER="claude-temp"
CLAUDE_BIN=$(which claude)

if [ -z "$CLAUDE_BIN" ]; then
    echo "Error: claude not found in PATH"
    exit 1
fi

# Create temp user if it doesn't exist
if ! id "$TEMP_USER" &>/dev/null; then
    echo "Creating temporary user: $TEMP_USER"
    useradd -m "$TEMP_USER"
fi

# Give temp user access to claude binary and venv
chmod o+x /root
chmod -R o+rX /root/.venv 2>/dev/null

# Give temp user ownership of current directory
WORK_DIR=$(pwd)
chown -R "$TEMP_USER":"$TEMP_USER" "$WORK_DIR"

# Run claude as temp user, passing all arguments through
exec su -c "$CLAUDE_BIN $*" "$TEMP_USER"
